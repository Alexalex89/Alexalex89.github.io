<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=32879&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Use your heatpump efficiently with sun energy - alexander alexandrowitz</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Create a Home Assistant automation to load your hot water tank when the sun is shining" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="http://localhost:32879/posts/heatpump-sun-energy/">
  <meta property="og:site_name" content="alexander alexandrowitz">
  <meta property="og:title" content="Use your heatpump efficiently with sun energy">
  <meta property="og:description" content="Create a Home Assistant automation to load your hot water tank when the sun is shining">
  <meta property="og:locale" content="de_de">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-23T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-06-23T00:00:00+00:00">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Use your heatpump efficiently with sun energy">
  <meta name="twitter:description" content="Create a Home Assistant automation to load your hot water tank when the sun is shining">
<script src="http://localhost:32879/js/feather.min.js"></script>
	
	
        <link href="http://localhost:32879/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:32879/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:32879/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css" media="(prefers-color-scheme: dark)"  />
	

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:32879/">alexander alexandrowitz</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/about">About</a>
		
		<a href="/imprint-privacy">Imprint/Privacy</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Use your heatpump efficiently with sun energy</h1>
			<div class="meta">Posted on Jun 23, 2024</div>
		</div>
		

		<section class="body">
			<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>up-to-date <a href="https://www.home-assistant.io/" target="_blank" rel="noopener">Home Assistant</a> installation</li>
<li>photovoltaic system which sends production data to Home Assistant</li>
<li>heat pump which can be controlled by Home Assistant</li>
<li>a helper variable (type <code>bool</code>) which indicates photovoltaic electricity surplus</li>
<li>an integration to get remaining photovoltaic production of the day (<a href="https://www.home-assistant.io/integrations/forecast_solar/" target="_blank" rel="noopener">Forecast Solar integration</a>)</li>
<li><strong>important</strong>: I have a Viessmann heat pump (vitocal 200a), which might work different than yours</li>
<li><strong>I&rsquo;m afraid you won&rsquo;t be able to use this Automation as Ctrl+C; Ctrl+V with your setup, but at least you will have a good starting point.</strong></li>
</ul>
<h2 id="how-it-works">How it works</h2>
<p>I was working on (my) perfect automation for over one and a half years and now I&rsquo;m quite happy with it for a while.
We don&rsquo;t have a battery for our photovoltaic system, so I was trying to find a solution which enables my heat pump to use as much clean energy as possible during sun-hours.
Basically it&rsquo;s just that I increase the temperature of my hot water tank when some conditions are right.</p>
<p>When enough energy is available, the automation checks if one of the following is <em>true</em> and increases the temperature:</p>
<ul>
<li><strong>A</strong>: The water temperature is more than 4 degrees below the target temperature.
<ul>
<li>this means that new warm water is needed very soon.</li>
</ul>
</li>
<li><strong>B</strong>: The temperature is just below the target temperature (1-2 degrees) and the remaining daily energy production is low (&lt; 25 kWh).
<ul>
<li>this means that there might be time left to produce warm water, but depending on the remaining energy prediction it is a good idea to start right away.</li>
</ul>
</li>
<li><strong>C</strong>: The temperature is slightly further below the target temperature (1-4 degrees) and the remaining daily energy production is moderate (&lt; 35 kWh).
<ul>
<li>this means that there might be little time left to produce warm water, but depending on the remaining energy prediction it is a good idea to start right away.</li>
</ul>
</li>
<li><strong>D</strong>: The heat pump is already active and the valve is set to water heating.
<ul>
<li>it&rsquo;s not good for the heat pump to be started frequently. So if it&rsquo;s already running, we should increase the temperature now!</li>
</ul>
</li>
</ul>
<p>My Viessmann heat pump has a functionality called 1xWW (more or less starting a manual warm water production, but with a different target temperature). My usual temperature is set to 43 degrees Celsius and the increased temperature to 50 degrees Celsius. The only condition to start this mode is that the hysteresis of the target temperature is reached, which is set to 5K in my case. In other words, it has to be below (50-5=45) degrees Celsius.</p>
<p>After checking the conditions, the automation is waiting for a few minutes to check if the energy conditions are still good.</p>
<h2 id="the-script">The script</h2>
<p>Here&rsquo;s my script, you might have to adjust the params according to your variable names.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">alias</span>: <span style="color:#ae81ff">Heatpump WW</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">trigger</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">platform</span>: <span style="color:#ae81ff">time_pattern</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">minutes</span>: <span style="color:#ae81ff">/2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">condition</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">or</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">conditions</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">state</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">sensor.wp_betriebsart</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#ae81ff">Heizen und Warmwasser</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">state</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">sensor.wp_betriebsart</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#ae81ff">Warmwasser</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">state</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">binary_sensor.strom_uebrig_ohne_wp_neu</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#34;on&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value_template</span>: &gt;-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      {{ (as_timestamp(now()) -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      as_timestamp(states(&#39;input_datetime.last_wp_ww_activation&#39;))) &gt; 3600 }}</span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">or</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">conditions</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">template</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value_template</span>: &gt;-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          {{ states(&#39;sensor.wp_ww_ist_oben&#39;)|float &lt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          (states(&#39;sensor.wp_ww_soll&#39;)|float - 4) }}</span>          
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">and</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">conditions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">template</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">value_template</span>: &gt;-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              {{ states(&#39;sensor.wp_ww_ist_oben&#39;)|float &gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              (states(&#39;sensor.wp_ww_soll&#39;)|float - 1) }}</span>              
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">template</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">value_template</span>: &gt;-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              {{ states(&#39;sensor.wp_ww_ist_oben&#39;)|float &lt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              ([states(&#39;sensor.wp_ww_soll&#39;)|float + 2, 45]|min) }}</span>              
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">template</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">value_template</span>: &gt;-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              {{ states(&#39;sensor.energy_production_today_remaining&#39;)|float &lt; 25
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              }}</span>              
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">and</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">conditions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">template</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">value_template</span>: &gt;-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              {{ states(&#39;sensor.wp_ww_ist_oben&#39;)|float &gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              (states(&#39;sensor.wp_ww_soll&#39;)|float - 4) }}</span>              
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">template</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">value_template</span>: &gt;-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              {{ states(&#39;sensor.wp_ww_ist_oben&#39;)|float &lt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              (states(&#39;sensor.wp_ww_soll&#39;)|float - 1) }}</span>              
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">template</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">value_template</span>: &gt;-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              {{ states(&#39;sensor.energy_production_today_remaining&#39;)|float &lt; 35
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              }}</span>              
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">and</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">conditions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">state</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">binary_sensor.wp_status_verdichter</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#34;on&#34;</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">state</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">sensor.wp_ventil</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">state</span>: <span style="color:#ae81ff">WW</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">action</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">delay</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">minutes</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">if</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">state</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">binary_sensor.strom_uebrig_ohne_wp_neu</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#34;off&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">then</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">stop</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">service</span>: <span style="color:#ae81ff">mqtt.publish</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">qos</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">retain</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">topic</span>: <span style="color:#ae81ff">openv/set1xWWein</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">payload</span>: <span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">service</span>: <span style="color:#ae81ff">input_datetime.set_datetime</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">input_datetime.last_wp_ww_activation</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">datetime</span>: <span style="color:#e6db74">&#34;{{ now().isoformat() }}&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">delay</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hours</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">minutes</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">seconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">milliseconds</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mode</span>: <span style="color:#ae81ff">single</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">trace</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stored_traces</span>: <span style="color:#ae81ff">720</span>
</span></span></code></pre></div>
		</section>

		<div class="post-tags">
			
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/alexalex89" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://www.linkedin.com/in/alexander-alexandrowitz-791683186/" rel="me" title="LinkedIn"><i data-feather="linkedin"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  © alexquadrat |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
